<!DOCTYPE html>
<html>

<head>
    <title>Bao Duy's Resume</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tektur&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Include marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Include Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
</head>

<body>
    <div id="floating-settings-menu">
        <button id="settings-toggle-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px">
                <path d="M0 0h24v24H0z" fill="none"/>
                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
        </button>
        <div id="settings-content">
            <label for="font-select">Font:</label>
            <select id="font-select">
                <option value="Arial, sans-serif">Arial</option>
                <option value="Calibri, sans-serif">Calibri</option>
                <option value="Helvetica, sans-serif">Helvetica</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="Montserrat, sans-serif">Montserrat</option>
                <option value="Tahoma, sans-serif">Tahoma</option>
                <option value="Aptos, sans-serif">Aptos</option>
                <option value="Roboto, sans-serif" selected>Roboto</option>
                <option value="Open Sans, sans-serif">Open Sans</option>
                <option value="Lato, sans-serif">Lato</option>
                <option value="Raleway, sans-serif">Raleway</option>
                <option value="Jetbrains Mono, monospace">Jetbrains Mono</option>
                <option value="Hasklig, monospace">Hasklig</option>
                <option value="Tektur, sans-serif">Tektur</option>
                <option value="Cambria, serif">Cambria</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Times New Roman, serif">Times New Roman</option>
                <option value="Garamond, serif">Garamond</option>
                <option value="Palatino, serif">Palatino</option>
            </select>
            <label for="language-select">Language:</label>
            <select id="language-select">
                <option value="en">English</option>
                <option value="vi">Tiếng Việt</option>
            </select>
            <label for="markdown-selector">CV Type:</label>
            <select id="markdown-selector">
                <option value="cv_fullstack_developer.md" selected>Fullstack Developer CV</option>
                <option value="cv_mobile_developer.md">Mobile Developer CV</option>
            </select>
            <a id="pdf-download-link" href="#" download class="download-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                </svg>
                Download CV (PDF)
            </a>
        </div>
    </div>
    <div id="markdown-container">Loading Markdown...</div>

    <script>
        async function renderMarkdown(markdownContent) {
            // Configure marked.js to use GitHub Flavored Markdown
            marked.setOptions({
                gfm: true,
                breaks: true,
                highlight: function (code, lang) {
                    if (Prism.languages[lang]) {
                        return Prism.highlight(code, Prism.languages[lang], lang);
                    }
                    return code;
                }
            });
            return marked.parse(markdownContent);
        }

        async function loadAndRenderMarkdown(filename) {
            try {
                document.getElementById('markdown-container').innerHTML = 'Loading ' + filename + '...';
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const markdown = await response.text();
                const html = await renderMarkdown(markdown);
                document.getElementById('markdown-container').innerHTML = html;
            } catch (error) {
                console.error('Error loading or rendering markdown:', error);
                document.getElementById('markdown-container').innerHTML = '<p style="color: red;">Failed to load ' + filename + '.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const markdownSelector = document.getElementById('markdown-selector');
            const fontSelect = document.getElementById('font-select');
            const languageSelect = document.getElementById('language-select'); // Get reference to language selector
            const pdfDownloadLink = document.getElementById('pdf-download-link');
            const bodyElement = document.body; // Reference to the body element

            // Function to get the language-specific filename
            function getLanguageFilename(baseFilename, lang) {
                if (lang === 'en') {
                    return baseFilename.replace('.md', '_en.md');
                } else if (lang === 'vi') {
                    return baseFilename.replace('.md', '_vi.md');
                }
                return baseFilename; // Fallback to original if no language or unknown language
            }

            async function loadAndRenderMarkdown(baseFilename, lang) {
                const filename = getLanguageFilename(baseFilename, lang);
                try {
                    document.getElementById('markdown-container').innerHTML = 'Loading ' + filename + '...';
                    const response = await fetch(filename);
                    if (!response.ok) {
                        // If language-specific file not found, try fallback to base filename
                        if (filename !== baseFilename) {
                            console.warn(`Language-specific file ${filename} not found, trying ${baseFilename}`);
                            const fallbackResponse = await fetch(baseFilename);
                            if (!fallbackResponse.ok) {
                                throw new Error(`HTTP error! status: ${fallbackResponse.status} for both ${filename} and ${baseFilename}`);
                            }
                            const markdown = await fallbackResponse.text();
                            const html = await renderMarkdown(markdown);
                            document.getElementById('markdown-container').innerHTML = html;
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status} for ${filename}`);
                    }
                    const markdown = await response.text();
                    const html = await renderMarkdown(markdown);
                    document.getElementById('markdown-container').innerHTML = html;
                } catch (error) {
                    console.error('Error loading or rendering markdown:', error);
                    document.getElementById('markdown-container').innerHTML = '<p style="color: red;">Failed to load ' + filename + '.</p>';
                }
            }

            function updatePdfDownloadLink(markdownFilename, lang) {
                const pdfFilename = getLanguageFilename(markdownFilename, lang).replace('.md', '.pdf');
                pdfDownloadLink.href = pdfFilename;
                pdfDownloadLink.download = pdfFilename;
            }

            markdownSelector.addEventListener('change', (event) => {
                const selectedMarkdown = event.target.value;
                const selectedLanguage = languageSelect.value;
                loadAndRenderMarkdown(selectedMarkdown, selectedLanguage);
                updatePdfDownloadLink(selectedMarkdown, selectedLanguage);
            });

            fontSelect.addEventListener('change', (event) => {
                bodyElement.style.fontFamily = event.target.value;
            });

            languageSelect.addEventListener('change', (event) => {
                const selectedLanguage = event.target.value;
                localStorage.setItem('selectedLanguage', selectedLanguage); // Store language preference
                const selectedMarkdown = markdownSelector.value;
                loadAndRenderMarkdown(selectedMarkdown, selectedLanguage);
                updatePdfDownloadLink(selectedMarkdown, selectedLanguage);
            });

            // Initialize language from localStorage or default to 'en'
            const storedLanguage = localStorage.getItem('selectedLanguage');
            if (storedLanguage) {
                languageSelect.value = storedLanguage;
            } else {
                languageSelect.value = 'en'; // Default language
            }

            // Load the initially selected markdown file and update PDF link
            const initialMarkdown = markdownSelector.value;
            const initialLanguage = languageSelect.value;
            loadAndRenderMarkdown(initialMarkdown, initialLanguage);
            updatePdfDownloadLink(initialMarkdown, initialLanguage);

            // Set initial font based on the default selected option
            bodyElement.style.fontFamily = fontSelect.value;

            // Floating settings menu toggle
            const settingsToggleButton = document.getElementById('settings-toggle-button');
            const floatingSettingsMenu = document.getElementById('floating-settings-menu'); // Get reference to the parent menu element

            let hasDragged = false; // Flag to track if the menu has been dragged

            settingsToggleButton.addEventListener('click', () => {
                // Only toggle if the menu was not dragged and is not currently being dragged
                if (!isDragging && !hasDragged) {
                    floatingSettingsMenu.classList.toggle('collapsed'); // Toggle the 'collapsed' class

                    // After toggling, check if the menu is now expanded and adjust position if needed
                    if (!floatingSettingsMenu.classList.contains('collapsed')) {
                        // Wait a tick for potential DOM updates if any (though unlikely needed here)
                        requestAnimationFrame(() => {
                            const menuRect = settingsMenu.getBoundingClientRect();
                            const viewportWidth = window.innerWidth;
                            const menuWidth = menuRect.width;
                            const menuLeft = menuRect.left;

                            // Calculate the right edge of the menu
                            const menuRightEdge = menuLeft + menuWidth;

                            // If the right edge exceeds the viewport, adjust the left position
                            if (menuRightEdge > viewportWidth) {
                                // Calculate how much it overflows
                                const overflowX = menuRightEdge - viewportWidth;
                                // Adjust left position to bring it back within bounds
                                settingsMenu.style.left = `${menuLeft - overflowX}px`;
                            }

                            // Ensure left edge is not off-screen (should be handled by drag constraints, but good for safety)
                            if (menuRect.left < 0) {
                                settingsMenu.style.left = '0px';
                            }
                        });
                    }
                }
            });

            // Drag and drop functionality for the floating settings menu
            const settingsMenu = document.getElementById('floating-settings-menu');
            const settingsToggleButtonForDrag = document.getElementById('settings-toggle-button'); // Use the button as the drag handle

            let isDragging = false;
            let offsetX, offsetY;
            let currentX, currentY;

            // Function to handle touch events as well
            function getEventXY(event) {
                if (event.type.startsWith('touch')) {
                    return {
                        x: event.touches[0].clientX,
                        y: event.touches[0].clientY
                    };
                } else {
                    return {
                        x: event.clientX,
                        y: event.clientY
                    };
                }
            }

            settingsToggleButtonForDrag.addEventListener('mousedown', (e) => {
                isDragging = true;
                hasDragged = false; // Reset drag flag on mousedown
                const menuRect = settingsMenu.getBoundingClientRect();
                const eventXY = getEventXY(e);
                currentX = menuRect.left;
                currentY = menuRect.top;
                offsetX = eventXY.x - currentX;
                offsetY = eventXY.y - currentY;

                // Add event listeners to the document to capture mousemove and mouseup globally
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                // Add touch event listeners
                document.addEventListener('touchmove', onMouseMove);
                document.addEventListener('touchend', onMouseUp);
            });

            function onMouseMove(event) {
                if (!isDragging) return;

                hasDragged = true; // Set flag if movement occurs

                const eventXY = getEventXY(event);
                currentX = eventXY.x - offsetX;
                currentY = eventXY.y - offsetY;

                // Get viewport dimensions
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                // Get menu dimensions
                const menuWidth = settingsMenu.offsetWidth;
                const menuHeight = settingsMenu.offsetHeight;

                // Calculate boundaries
                const minX = 0;
                const maxX = viewportWidth - menuWidth;
                const minY = 0;
                const maxY = viewportHeight - menuHeight;

                // Clamp position to stay within viewport
                currentX = Math.max(minX, Math.min(currentX, maxX));
                currentY = Math.max(minY, Math.min(currentY, maxY));

                // Update element's position
                settingsMenu.style.left = `${currentX}px`;
                settingsMenu.style.top = `${currentY}px`;
                settingsMenu.style.right = 'auto'; // Ensure right is not interfering
                settingsMenu.style.bottom = 'auto'; // Ensure bottom is not interfering
            }

            function onMouseUp() {
                isDragging = false;
                // Remove event listeners
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.removeEventListener('touchmove', onMouseMove);
                document.removeEventListener('touchend', onMouseUp);
            }
        });
    </script>
</body>

</html>